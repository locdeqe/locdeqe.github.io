
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="style.css">
</head>
  <body>
    <div class="checkboxes">
        <span>Filter by:</span>
        <input type="checkbox" name="Americas" value="Americas" title="Americas"><label for = "Americas">Americas</label>
        <input type="checkbox" name="Africa" value="Africa" title="Africa"><label for = "Africa">Africa</label>
        <input type="checkbox" name="Asia" value="Asia" title="Asia"><label for = "Asia">Asia</label>
        <input type="checkbox" name="Europe" value="Europe" title="Europe"><label for = "Europe">Europe</label>
        <input type="checkbox" name="Oceania" value="Oceania" title="Oceania"><label for = "Oceania">Oceania</label>
    </div>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script>
    d3.json("countries_2012.json", function(error, data){
        
     	var valueData = data.data.map(getValuebleInfo);
        
        var columns = Object.keys(valueData[0]);

        var table = d3.select("body").append("table"),
            thead = table.append("thead")
                         .attr("class", "thead");
            tbody = table.append("tbody");

        table.append("caption")
          .html("World Countries Ranking");

        thead.append("tr").selectAll("th")
            .data(columns)
            .enter()
            .append("th")
            .text(function(d) { return d; })
            .on("click", function(header) {
            if (data.sorted == "toLower"+header) {
                tbody.selectAll("tr").sort(function(a, b) {
                    if (a[header] == b[header]) {
                        return;
                    }

                    if ( parseFloat(a[header]) >= 0){
                        return parseFloat(b[header]) - parseFloat(a[header]);
                    }
                    
                    return b[header].localeCompare(a[header]);
                    
                });
            
                data.sorted = "toUpper"+header;
            } else {
                tbody.selectAll("tr").sort(function(a, b) {
                    debugger;
                    if (a[header] == b[header]) {
                        return;
                    }

                    if ( parseFloat(a[header]) || a[header] == 0){
                        return parseFloat(a[header]) - parseFloat(b[header]);
                    }
                    
				    return a[header].localeCompare(b[header]);
                });
                data.sorted = "toLower"+header;
            }
          });
        
        var rows = tbody.selectAll("tr")
          .data(valueData)
          .enter()
          .append("tr");

        var cells = rows.selectAll("td")
          .data(getInfoFromRow)
          .enter()
          .append("td")
          .text(function(d) { return d; });
         
        d3.selectAll(".checkboxes input").on("change", function(){             
            var checkedBoxes = [];
            var filtredData = [];
            
            
            d3.selectAll('input:checked').each(function(){
                checkedBoxes.push(this.value);
            });
            
            if (!checkedBoxes.length || checkedBoxes.length == 4) {
                filtredData = data.data.slice();
            } else {
                data.data.forEach(function(current) {
                    if (checkedBoxes.indexOf(current['continent']) > -1 ) {
                        filtredData.push(current);
                    }
                });
            } 
           
            console.log(filtredData);
            filtredData = filtredData.map(getValuebleInfo);
            
            
            var rows = d3.select("tbody").selectAll("tr").data(filtredData);
            
            var cells = rows.selectAll("td")
                            .data(getInfoFromRow);
            
            cells.enter().append('td');
            cells.text(function (d) {return d});
            cells.exit().remove();
            
            var cells_in_new_rows = rows.enter().append('tr')
                                .selectAll('td')
                                .data(getInfoFromRow);

            cells_in_new_rows.enter().append('td');
            cells_in_new_rows.text(function (d) {return d});
            
            rows.exit().remove();
            
        });
        
        function getValuebleInfo (currentObj) {
            return newObj = {
                name: currentObj.name,
                continent: currentObj.continent,
                gdp: currentObj.gdp,
                life_expectancy: currentObj.life_expectancy,
                population: currentObj.population,
                year: currentObj.year
            }
        }
        
        function getInfoFromRow(row) {
              return d3.range(Object.keys(row).length).map(function(column, i) {
                  return makeFormating(Object.keys(row)[i], row[Object.keys(row)[i]]);
              });
          }
        
        function makeFormating (name, value){
            var formObj = {
                gdp: function(val) {
                    return d3.format(".2s")(val);
                },
                
                life_expectancy: function(val) {
                    return d3.format(".1f")(val);
                },
                
                population: function(val) {
                    return d3.format(",.3")(val);
                }
            }
            
            if (formObj[name]) {
                return formObj[name](value);
            }
            
            return value;
         }
        
        
    })
    </script> 
  </body>
</html>